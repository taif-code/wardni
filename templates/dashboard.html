{% extends "base.html" %}
{% block content %}
<h2>{{ T.dashboard }}</h2>

<div class="cards">
  <div class="card">
    <div class="icon">🚚</div>
    <div>
      <div class="label">{{ T.shipmentsInTransit }}</div>
      <div class="metric">{{ in_transit|length }}</div>
    </div>
  </div>
  <div class="card">
    <div class="icon">🌡️</div>
    <div>
      <div class="label">{{ T.avgTemp }}</div>
      <div class="metric">{{ avg_temp }}{{ T.tempUnit }}</div>
    </div>
  </div>
  <div class="card">
    <button class="icon" id="bell">🔔</button>
    <div>
      <div class="label">{{ T.alerts }}</div>
      <div class="metric">{{ alerts|length }}</div>
    </div>
  </div>
</div>

<ul id="alerts" class="alerts hidden">
  {% for a in alerts %}<li>{{ a }}</li>{% endfor %}
</ul>

<div class="grid2">
  <div class="panel">
    <h3>{{ T.reports }}</h3>
    <div class="sub">
      {{ T.last7days }}
    </div>
    <div style="height:220px">
      <canvas id="chart" data-label="{{ 'Success' if lang_code=='en' else 'الناجحة' }}"></canvas>
    </div>
  </div>

  <div class="panel">
    <h3>{{ T.shipments }}</h3>
    <ul class="list">
      {% for s in shipments %}
      <li class="row">
        <div>
          📦 <strong>{{ s.id }}</strong><br />
          <small>{{ s.origin|trans }} <span class="dir-arrow"></span> {{ s.destination|trans }}</small>
        </div>
        <div class="muted">{{ s.status|trans }} • {{ s.temp }}{{ T.tempUnit }}</div>
      </li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script id="chart-data" type="application/json">{{ chart|tojson|safe }}</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Toggle alerts
  document.getElementById('bell').onclick = () => {
    document.getElementById('alerts').classList.toggle('hidden');
  };

  // Chart data
  const canvas = document.getElementById('chart');
  const datasetLabel = canvas.dataset.label; // "Success" أو "الناجحة"
  const raw = document.getElementById('chart-data').textContent;
  const chartData = JSON.parse(raw); // [{day, success}, ...]

  const labels = chartData.map(x => x.day);
  const series = chartData.map(x => x.success);

  new Chart(canvas, {
    type: 'line',
    data: {
      labels,
      datasets: [{ label: datasetLabel, data: series, borderWidth: 2 }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
</script>
{% endblock %}
