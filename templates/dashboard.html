{% extends "base.html" %}
{% block content %}
<h2>لوحة التحكم</h2>
<div class="cards">
  <div class="card">
    <div class="icon">🚚</div>
    <div>
      <div class="label">شحنات قيد النقل</div>
      <div class="metric">{{ in_transit|length }}</div>
    </div>
  </div>
  <div class="card">
    <div class="icon">🌡️</div>
    <div>
      <div class="label">متوسط الحرارة</div>
      <div class="metric">{{ avg_temp }}°C</div>
    </div>
  </div>
  <div class="card">
    <button class="icon" id="bell">🔔</button>
    <div>
      <div class="label">تنبيهات</div>
      <div class="metric">{{ alerts|length }}</div>
    </div>
  </div>
</div>

<ul id="alerts" class="alerts hidden">
  {% for a in alerts %}<li>{{ a }}</li>{% endfor %}
</ul>

<div class="grid2">
  <div class="panel">
    <h3>التقارير</h3>
    <div class="sub">عدد الشحنات الناجحة (آخر 7 أيام)</div>
    <canvas id="chart" height="180"></canvas>
  </div>
  <div class="panel">
    <h3>الشحنات</h3>
    <ul class="list">
      {% for s in shipments %}
      <li class="row">
        <div>📦 <strong>{{ s.id }}</strong><br><small>{{ s.origin }} → {{ s.destination }}</small></div>
        <div class="muted">{{ s.status }} • {{ s.temp }}°C</div>
      </li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.getElementById('bell').onclick = () => {
  document.getElementById('alerts').classList.toggle('hidden');
};
const ctx = document.getElementById('chart');
const data = {{ chart|tojson }}.map(x => x.success);
const labels = {{ chart|tojson }}.map(x => x.day);
new Chart(ctx, {type: 'line', data: {labels, datasets: [{label: 'Success', data, borderWidth: 2}]} , options:{responsive:true}});
</script>
{% endblock %}
